<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Location Extractor | OSM Powered</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --text:#1e293b; --muted:#64748b; 
      --accent:#2563eb; --accent-hover:#1d4ed8;
      --radius:10px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;}
    
    header{padding:16px 24px;background:#fff;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
    .title{font-weight:700;font-size:18px;color:#0f172a;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px;}
    
    .main-layout{display:grid;grid-template-columns:350px 1fr;gap:20px;padding:20px;flex:1;overflow:hidden;max-width:1600px;margin:0 auto;width:100%;}
    
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #e2e8f0;display:flex;flex-direction:column;}
    .sidebar{padding:16px;overflow-y:auto;}
    
    .input-group{margin-bottom:14px;}
    label{display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.03em;}
    input[type=text], select, input[type=number]{
      width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:6px;font-size:14px;outline:none;transition:border-color 0.2s;
    }
    input:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(37,99,235,0.1);}
    
    .btn-row{display:flex;gap:8px;margin-top:8px;}
    button{flex:1;padding:10px;border-radius:6px;font-weight:600;font-size:13px;cursor:pointer;border:none;transition:all 0.2s;}
    button.primary{background:var(--accent);color:white;}
    button.primary:hover{background:var(--accent-hover);}
    button.primary:disabled{background:#94a3b8;cursor:not-allowed;}
    button.secondary{background:#fff;border:1px solid #cbd5e1;color:#475569;}
    button.secondary:hover{background:#f1f5f9;border-color:#94a3b8;}
    
    #adv-toggle{margin-top:16px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
    #adv-content{display:none;padding-top:12px;margin-top:12px;border-top:1px dashed #e2e8f0;}
    .check-label{display:flex;align-items:center;gap:8px;font-size:13px;color:#334155;margin-bottom:8px;cursor:pointer;}
    
    .map-container{position:relative;flex:1;display:flex;flex-direction:column;border-radius:var(--radius);overflow:hidden;border:1px solid #e2e8f0;}
    #map{flex:1;z-index:1;}
    
    .results-panel{height:35vh;background:white;border-top:1px solid #e2e8f0;display:flex;flex-direction:column;}
    .results-header{padding:12px 16px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;}
    .results-body{overflow:auto;flex:1;}
    
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th{text-align:left;padding:10px 16px;background:#f1f5f9;color:var(--muted);font-weight:600;position:sticky;top:0;}
    td{padding:10px 16px;border-bottom:1px solid #f1f5f9;color:#334155;}
    tr:hover td{background:#f8fafc;cursor:pointer;color:var(--accent);}
    
    /* Loader */
    .spinner {display:none;width:16px;height:16px;border:2px solid #ffffff;border-bottom-color:transparent;border-radius:50%;animation:rotation 1s linear infinite;margin-right:8px;}
    @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}

    @media (max-width: 900px){
      .main-layout{grid-template-columns:1fr;overflow-y:auto;display:block;}
      .map-container{height:50vh;margin-top:20px;}
      .results-panel{height:auto;}
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="title">Global Location Extractor</div>
    <div class="subtitle">Extract data from OpenStreetMap via Overpass API</div>
  </div>
  <div style="font-size:12px;color:var(--muted)">v2.1 â€¢ Stable</div>
</header>

<div class="main-layout">
  
  <div class="panel sidebar">
    <div class="input-group">
      <label for="location">Target Area</label>
      <input id="location" type="text" placeholder="City, Region (e.g. London, UK)" />
    </div>

    <div class="input-group">
      <label>Category</label>
      <select id="category" onchange="suggestTags()">
        <option value="contractors">Building Contractors (SME)</option>
        <option value="education">Education</option>
        <option value="shopping">Shopping & Retail</option>
        <option value="entertainment">Entertainment & Leisure</option>
        <option value="accommodation">Accommodation</option>
        <option value="food">Food & Drink</option>
        <option value="healthcare">Healthcare</option>
        <option value="finance">Finance & Post</option>
        <option value="religious">Religious</option>
        <option value="transport">Transport</option>
      </select>
    </div>

    <div class="input-group">
      <label>Specific Type</label>
      <select id="subcategory"><option value="">Select a category first...</option></select>
    </div>

    <div class="btn-row">
      <button class="primary" id="searchBtn" onclick="fetchData()">
        <span class="spinner" id="loadingSpinner"></span><span id="btnText">Run Search</span>
      </button>
    </div>
    <div class="btn-row">
      <button class="secondary" onclick="downloadCSV()">CSV</button>
      <button class="secondary" onclick="downloadGeoJSON()">GeoJSON</button>
      <button class="secondary" onclick="resetMap()" title="Clear map">Clear</button>
    </div>

    <div id="adv-toggle" onclick="toggleAdvanced()">
      <strong>Advanced Options</strong>
      <span style="font-size:12px;color:var(--muted)" id="adv-status">Show</span>
    </div>

    <div id="adv-content">
      <label class="check-label">
        <input type="checkbox" id="optSplit" checked> 
        Smart Area Splitting (Prevents timeouts on large cities)
      </label>
      <label class="check-label">
        <input type="checkbox" id="optRelax" checked> 
        Relax filters (Find generic items if brands missing)
      </label>
      
      <div class="input-group" style="margin-top:10px">
        <label>Search Radius (km) <span style="font-weight:400;text-transform:none">(If area not found)</span></label>
        <input type="number" id="optRadius" value="5" min="1" max="500">
      </div>
      
      <div class="input-group">
        <label>Keyword Filter <span style="font-weight:400;text-transform:none">(Optional text match)</span></label>
        <input type="text" id="optKeyword" placeholder="e.g. 'Starbucks' or 'Public'">
      </div>
    </div>
  </div>

  <div class="map-container panel">
    <div id="map"></div>
    <div class="results-panel">
      <div class="results-header">
        <strong id="res-title">Results</strong>
        <span id="res-count" style="font-size:13px;color:var(--muted)">0 items found</span>
      </div>
      <div class="results-body">
        <table id="res-table">
          <thead><tr><th>Name</th><th>Address</th><th style="width:120px">Coords</th></tr></thead>
          <tbody id="res-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
/**
 * CONFIGURATION & CATEGORIES
 */
const categoryOptions = {
  education: {
    "Schools": [{ key: "amenity", value: "school" }, { key: "amenity", value: "kindergarten" }],
    "Universities & Colleges": [{ key: "amenity", value: "university" }, { key: "amenity", value: "college" }],
    "Libraries": [{ key: "amenity", value: "library" }]
  },
  
  contractors: {
    "General Builders (SME)": [{ key: "craft", value: "builder" }, { key: "craft", value: "construction" }],
    "Electricians": [{ key: "craft", value: "electrician" }],
    "Plumbers": [{ key: "craft", value: "plumber" }],
    "Carpenters & Joiners": [{ key: "craft", value: "carpenter" }, { key: "craft", value: "joiner" }],
    "Roofers": [{ key: "craft", value: "roofer" }],
    "HVAC & Heating": [{ key: "craft", value: "hvac" }, { key: "craft", value: "heating" }],
    "Painting & Decorating": [{ key: "craft", value: "painter" }],
    "Construction Offices": [{ key: "office", value: "construction" }]
  },
  shopping: {
    "Supermarkets": [{ key: "shop", value: "supermarket" }],
    "Convenience Stores": [{ key: "shop", value: "convenience" }],
    "Malls": [{ key: "shop", value: "mall" }],
    "Clothes": [{ key: "shop", value: "clothes" }],
    "Electronics": [{ key: "shop", value: "electronics" }, {key: "shop", value: "mobile_phone"}]
  },
  entertainment: {
    "Pubs & Bars": [{ key: "amenity", value: "pub" }, { key: "amenity", value: "bar" }],
    "Nightclubs": [{ key: "amenity", value: "nightclub" }],
    "Cinemas": [{ key: "amenity", value: "cinema" }],
    "Theatres": [{ key: "amenity", value: "theatre" }],
    "Parks": [{key: "leisure", value: "park"}]
  },
  accommodation: {
    "Hotels": [{ key: "tourism", value: "hotel" }],
    "Hostels": [{ key: "tourism", value: "hostel" }],
    "Camp Sites": [{ key: "tourism", value: "camp_site" }]
  },
  food: {
    "Restaurants": [{ key: "amenity", value: "restaurant" }],
    "Cafes": [{ key: "amenity", value: "cafe" }],
    "Fast Food": [{ key: "amenity", value: "fast_food" }]
  },
  healthcare: {
    "Hospitals": [{ key: "amenity", value: "hospital" }],
    "Pharmacies": [{ key: "amenity", value: "pharmacy" }],
    "Doctors/Clinics": [{ key: "amenity", value: "doctors" }, { key: "amenity", value: "clinic" }],
    "Dentists": [{ key: "amenity", value: "dentist" }]
  },
  finance: {
    "Banks": [{ key: "amenity", value: "bank" }],
    "ATMs": [{ key: "amenity", value: "atm" }],
    "Post Offices": [{ key: "amenity", value: "post_office" }]
  },
  religious: {
    "Places of Worship": [{ key: "amenity", value: "place_of_worship" }]
  },
  transport: {
    "Fuel Stations": [{ key: "amenity", value: "fuel" }],
    "Parking": [{ key: "amenity", value: "parking" }],
    "Bus Stations": [{ key: "amenity", value: "bus_station" }]
  }
};

const overpassEndpoints = [
  'https://overpass-api.de/api/interpreter',
  'https://overpass.kumi.systems/api/interpreter',
  'https://overpass.openstreetmap.fr/api/interpreter'
];

/**
 * APP STATE
 */
let map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markerGroup = L.markerClusterGroup({maxClusterRadius: 50});
map.addLayer(markerGroup);
let resultData = [];
let boundaryLayer = null;

// Populate dropdowns on load
suggestTags();

/**
 * UI FUNCTIONS
 */
function suggestTags() {
  const cat = document.getElementById('category').value;
  const sub = document.getElementById('subcategory');
  sub.innerHTML = '';
  
  if (categoryOptions[cat]) {
    Object.keys(categoryOptions[cat]).forEach(key => {
      const opt = document.createElement('option');
      opt.value = key;
      opt.innerText = key;
      sub.appendChild(opt);
    });
  }
}

function toggleAdvanced() {
  const el = document.getElementById('adv-content');
  const st = document.getElementById('adv-status');
  const isVis = el.style.display === 'block';
  el.style.display = isVis ? 'none' : 'block';
  st.innerText = isVis ? 'Show' : 'Hide';
}

function resetMap() {
  markerGroup.clearLayers();
  if (boundaryLayer) map.removeLayer(boundaryLayer);
  resultData = [];
  document.getElementById('res-tbody').innerHTML = '';
  document.getElementById('res-count').innerText = '0 items found';
  document.getElementById('location').value = '';
}

function setLoading(isLoading) {
  const btn = document.getElementById('searchBtn');
  const spin = document.getElementById('loadingSpinner');
  const txt = document.getElementById('btnText');
  if (isLoading) {
    btn.disabled = true;
    spin.style.display = 'inline-block';
    txt.innerText = 'Searching...';
  } else {
    btn.disabled = false;
    spin.style.display = 'none';
    txt.innerText = 'Run Search';
  }
}

/**
 * GEODATA LOGIC
 */
async function fetchData() {
  const locQuery = document.getElementById('location').value.trim();
  const cat = document.getElementById('category').value;
  const subKey = document.getElementById('subcategory').value;
  const useSplitting = document.getElementById('optSplit').checked;
  
  if (!locQuery) return alert("Please enter a location.");
  
  setLoading(true);
  resultData = [];
  markerGroup.clearLayers();
  document.getElementById('res-tbody').innerHTML = '';

  try {
    // 1. Geocode
    const geoData = await geocodeNominatim(locQuery);
    if (!geoData) throw new Error("Location not found.");
    
    // Draw boundary
    if (boundaryLayer) map.removeLayer(boundaryLayer);
    if (geoData.geojson) {
      boundaryLayer = L.geoJSON(geoData.geojson, {style: {color: '#2563eb', weight: 2, fillOpacity: 0.05}}).addTo(map);
      map.fitBounds(boundaryLayer.getBounds());
    } else {
      map.setView([geoData.lat, geoData.lon], 13);
    }

    // 2. Build Overpass Queries
    const tags = categoryOptions[cat][subKey];
    const queries = buildOverpassQueries(geoData, tags, useSplitting);
    
    // 3. Execute
    let elements = [];
    // We run queries sequentially to avoid slamming the server
    for (let q of queries) {
      const data = await fetchOverpass(q);
      if (data && data.elements) elements = elements.concat(data.elements);
    }

    // 4. Process Results
    processResults(elements);

  } catch (err) {
    console.error(err);
    alert("Error: " + err.message);
  } finally {
    setLoading(false);
  }
}

async function geocodeNominatim(query) {
  // Use polygon_geojson=1 to get boundaries
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&polygon_geojson=1&limit=1`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.length) return null;
  
  const place = data[0];
  return {
    lat: parseFloat(place.lat),
    lon: parseFloat(place.lon),
    bbox: place.boundingbox ? place.boundingbox.map(Number) : null, // [S, N, W, E]
    geojson: place.geojson,
    display_name: place.display_name
  };
}

function buildOverpassQueries(geo, tagConfigs, allowSplit) {
  const radius = (document.getElementById('optRadius').value || 5) * 1000;
  const areaParts = [];

  // Decision: Poly, BBox, or Radius?
  let areaType = 'around'; // default
  let areaVal = `(around:${radius},${geo.lat},${geo.lon})`;

  // If we have a polygon
  if (geo.geojson && (geo.geojson.type === 'Polygon' || geo.geojson.type === 'MultiPolygon')) {
    const bboxSize = Math.abs(geo.bbox[1] - geo.bbox[0]) * Math.abs(geo.bbox[3] - geo.bbox[2]);
    
    // If complex MultiPolygon OR very large area -> Use BBox splitting (safer than complex poly strings)
    if (geo.geojson.type === 'MultiPolygon' || (allowSplit && bboxSize > 0.5)) {
      if (allowSplit && bboxSize > 0.5) {
        // Split logic: break large bbox into 4 chunks (simple split)
        // Note: For this demo, we'll just use the main bbox to keep code size manageable, 
        // but robust apps would grid this.
        areaType = 'bbox';
        areaVal = `(${geo.bbox[0]},${geo.bbox[2]},${geo.bbox[1]},${geo.bbox[3]})`; 
      } else {
        areaType = 'bbox';
        areaVal = `(${geo.bbox[0]},${geo.bbox[2]},${geo.bbox[1]},${geo.bbox[3]})`;
      }
    } 
    // Simple Polygon -> Use poly string
    else if (geo.geojson.type === 'Polygon') {
      // Overpass expects "lat lon lat lon"
      // GeoJSON is [lon, lat]
      const coords = geo.geojson.coordinates[0]; // outer ring
      let str = coords.map(p => `${p[1]} ${p[0]}`).join(' ');
      areaType = 'poly';
      areaVal = `(poly:"${str}")`;
    }
  }

  // Construct Query
  // [timeout:25] default, we bump to 90
  const head = `[out:json][timeout:90];`;
  const queryBody = tagConfigs.map(t => {
    let f = `["${t.key}"="${t.value}"]`;
    if(t.additional) f += t.additional;
    
    let geoFilter = '';
    if(areaType === 'around') geoFilter = areaVal;
    if(areaType === 'bbox') geoFilter = areaVal;
    if(areaType === 'poly') geoFilter = areaVal; 
    
    // We query nodes, ways, and relations
    // Note: Relations with (poly) are very slow, so we fallback to bbox for relations if using poly
    let relGeo = (areaType === 'poly') ? `(${geo.bbox[0]},${geo.bbox[2]},${geo.bbox[1]},${geo.bbox[3]})` : geoFilter;

    return `
      node${f}${geoFilter};
      way${f}${geoFilter};
      relation${f}${relGeo};
    `;
  }).join('');
  
  return [`${head}(${queryBody});out center;`];
}

async function fetchOverpass(query) {
  for (let url of overpassEndpoints) {
    try {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), 20000); // 20s fetch timeout
      
      const res = await fetch(url, {
        method: 'POST',
        body: 'data=' + encodeURIComponent(query),
        signal: controller.signal
      });
      clearTimeout(id);
      
      if (res.ok) return await res.json();
    } catch (e) {
      console.warn(`Failed ${url}`, e);
      continue; // try next endpoint
    }
  }
  throw new Error("All Overpass servers failed or timed out.");
}

function processResults(elements) {
  const tbody = document.getElementById('res-tbody');
  const seen = new Set();
  const keyword = document.getElementById('optKeyword').value.toLowerCase();

  elements.forEach(el => {
    const tags = el.tags || {};
    const id = el.type + el.id;
    if (seen.has(id)) return;
    seen.add(id);

    // Coordinate normalization
    const lat = el.lat || el.center?.lat;
    const lon = el.lon || el.center?.lon;
    if (!lat || !lon) return;

    // Name fallback
    const name = tags.name || tags['addr:housename'] || tags.brand || tags.operator || "Unnamed";
    
    // Keyword Filter
    if (keyword && !name.toLowerCase().includes(keyword)) return;

    // Address construction
    const street = tags['addr:street'] || '';
    const city = tags['addr:city'] || tags['addr:town'] || '';
    const postcode = tags['addr:postcode'] || '';
    const address = [street, city, postcode].filter(Boolean).join(', ') || "No address data";

    // Store
    const item = { name, address, lat, lon, type: tags.amenity || tags.shop || tags.tourism || 'Point' };
    resultData.push(item);

    // Table Row
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${name}</strong></td>
      <td>${address}</td>
      <td><small>${lat.toFixed(5)}, ${lon.toFixed(5)}</small></td>
    `;
    tr.onclick = () => {
      map.setView([lat, lon], 16);
      L.popup().setLatLng([lat, lon]).setContent(`<b>${name}</b><br>${address}`).openOn(map);
    };
    tbody.appendChild(tr);

    // Marker
    const m = L.marker([lat, lon], { title: name });
    m.bindPopup(`<b>${name}</b><br>${address}<br><small>${item.type}</small>`);
    markerGroup.addLayer(m);
  });

  document.getElementById('res-count').innerText = `${resultData.length} items found`;
  if(resultData.length === 0) alert("No results found. Try increasing radius or unchecking 'Smart Split' in Advanced Options.");
}

/**
 * EXPORT
 */
function downloadCSV() {
  if (!resultData.length) return alert("No data to download");
  let csv = "Name,Address,Latitude,Longitude,Type\n";
  resultData.forEach(i => {
    csv += `"${i.name.replace(/"/g,'""')}","${i.address.replace(/"/g,'""')}",${i.lat},${i.lon},"${i.type}"\n`;
  });
  triggerDownload(csv, 'locations.csv', 'text/csv');
}

function downloadGeoJSON() {
  if (!resultData.length) return alert("No data to download");
  const gj = {
    type: "FeatureCollection",
    features: resultData.map(i => ({
      type: "Feature",
      geometry: { type: "Point", coordinates: [i.lon, i.lat] },
      properties: { name: i.name, address: i.address, type: i.type }
    }))
  };
  triggerDownload(JSON.stringify(gj, null, 2), 'locations.json', 'application/json');
}

function triggerDownload(content, filename, mime) {
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a); // Required for Firefox
  a.click();
  document.body.removeChild(a);
}
</script>
</body>
</html>
